<script>

// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TEAMS = [
  { id: '193', display: 'Miami University',         emoji: 'â¤ï¸',  sub: 'RedHawks Â· MAC Â· Oxford, OH', cls: 'miami', vibe: 'love', tag: 'ðŸ’ª our team', confId: '15' },
  { id: '153', display: 'Univ. of North Carolina',  emoji: 'ðŸ’™',  sub: 'Tar Heels Â· ACC',             cls: 'unc',   vibe: 'love', tag: 'ðŸ’™ our team', confId: '2'  },
  { id: '150', display: 'Dook ðŸ¤¢',                  emoji: 'ðŸ¤®',  sub: 'ðŸ’© Blue Devils Â· ACC ðŸ’©',     cls: 'duke',  vibe: 'hate', tag: 'ðŸ—‘ï¸ boo ðŸ¤®',  confId: '2'  },
];

// Cache standings per conference so we only fetch each conf once per refresh
const confStandingsCache = {};


// â”€â”€â”€ FIXED CONFERENCE RECORD FUNCTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getConfRecord(teamId, confId) {
  if (!confStandingsCache[confId]) {
    const url = `https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/standings?group=${confId}`;
    try {
      const res = await fetch(url, { cache: 'no-store' });
      if (res.ok) confStandingsCache[confId] = await res.json();
    } catch (e) {
      return '';
    }
  }

  const data = confStandingsCache[confId];
  if (!data) return '';

  const children = data.children || [];

  for (const child of children) {
    const entries = child?.standings?.entries || [];

    for (const entry of entries) {
      if (entry.team?.id === String(teamId)) {
        const records = entry.records || [];
        const confRec = records.find(r => r.name === "vs. Conf.");
        if (confRec?.summary) {
          return confRec.summary;
        }
      }
    }
  }

  return '';
}


// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmtTime = d => new Date(d).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', timeZone: 'America/New_York' }) + ' ET';
const fmtDateShort = d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'America/New_York' });

function smartDate(dateStr, isUpcoming) {
  const now   = new Date();
  const game  = new Date(dateStr);
  const etNow  = new Date(now.toLocaleString('en-US',  { timeZone: 'America/New_York' }));
  const etGame = new Date(game.toLocaleString('en-US', { timeZone: 'America/New_York' }));
  const diffDays = Math.round((etGame.setHours(0,0,0,0) - etNow.setHours(0,0,0,0)) / 86400000);

  if (diffDays === 0)  return 'Tonight';
  if (diffDays === 1)  return 'Tomorrow';
  if (diffDays === -1) return 'Last night';
  if (diffDays === 2)  return 'In 2 days';
  return fmtDateShort(dateStr);
}

function getMe(comp, teamId)  { return comp.competitors?.find(c => c.team?.id === teamId); }
function getOpp(comp, teamId) { return comp.competitors?.find(c => c.team?.id !== teamId); }

function extractScore(c) {
  if (!c) return '?';
  const s = c.score;
  if (s == null) return '?';
  if (typeof s === 'object') return s.displayValue ?? s.value ?? '?';
  return s;
}

function periodLabel(comp) {
  const s = comp.status;
  if (!s) return '';
  const p = s.period || 0;
  const half = p === 1 ? '1st Half' : p === 2 ? '2nd Half' : 'OT';
  const clock = s.displayClock;
  return (clock && clock !== '0:00') ? `${half} Â· ${clock}` : half;
}


// â”€â”€â”€ FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchTeam(team) {

  const [schedRes, summaryRes] = await Promise.all([
    fetch(`https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/teams/${team.id}/schedule`, { cache: 'no-store' }),
    fetch(`https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/teams/${team.id}`, { cache: 'no-store' }),
  ]);

  if (!schedRes.ok) throw new Error(`HTTP ${schedRes.status}`);

  const data        = await schedRes.json();
  const summaryData = summaryRes.ok ? await summaryRes.json() : null;

  const events = (data.events || []).sort((a, b) => new Date(a.date) - new Date(b.date));

  let lastCompleted = null, liveGame = null, nextGame = null;
  const allGames = [];

  for (const ev of events) {
    const comp = ev.competitions?.[0];
    if (!comp) continue;
    const state = comp.status?.type?.state;
    allGames.push({ ev, comp, state });
    if      (state === 'post') lastCompleted = { ev, comp };
    else if (state === 'in')   liveGame      = { ev, comp };
    else if (state === 'pre' && !nextGame) nextGame = { ev, comp };
  }

  const teamInfo  = summaryData?.team || data.team || {};
  const recItems  = teamInfo?.record?.items || [];
  const totalRec  = recItems.find(r => r.type === 'total') || recItems[0];
  const recordStr = totalRec?.summary || '';

  const confRecordStr = await getConfRecord(team.id, team.confId);

  let apRank = null;
  const rankNum = teamInfo?.rank;
  if (rankNum && rankNum < 26) apRank = rankNum;

  return { team, lastCompleted, liveGame, nextGame, allGames, recordStr, confRecordStr, apRank };
}


// â”€â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAll() {
  Object.keys(confStandingsCache).forEach(k => delete confStandingsCache[k]);
  const grid = document.getElementById('grid');

  const results = await Promise.allSettled(TEAMS.map(fetchTeam));

  grid.innerHTML = results.map((r, i) =>
    r.status === 'fulfilled'
      ? `<div class="card ${r.value.team.cls}">
           <div class="card-front">
             <div class="team-name">${r.value.team.display}</div>
             <div class="record">
               ${r.value.recordStr || ''} ${r.value.confRecordStr ? ' Â· ' + r.value.confRecordStr + ' conf' : ''}
             </div>
           </div>
         </div>`
      : ''
  ).join('');

  document.getElementById('last-updated').textContent =
    new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', second: '2-digit' });
}

function manualRefresh() {
  loadAll();
}

loadAll();
setInterval(loadAll, 60000);

</script>
